<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Google Sheets - Innovemos</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .btn {
            background: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .status-warning {
            background: #fff3e0;
            color: #f57c00;
            border: 1px solid #ffcc02;
        }
        
        .log-area {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-top: 20px;
        }
        
        .diagnostic-info {
            background: #e8f4fd;
            border: 1px solid #64b5f6;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .error-details {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico Google Sheets API</h1>
        
        <div class="diagnostic-info">
            <h3>üìã Verificaci√≥n de Configuraci√≥n:</h3>
            <p><strong>Dominio actual:</strong> <span id="currentDomain"></span></p>
            <p><strong>Protocolo:</strong> <span id="currentProtocol"></span></p>
            <p><strong>User Agent:</strong> <span id="userAgent"></span></p>
        </div>

        <div class="section">
            <h3>‚öôÔ∏è Credenciales</h3>
            
            <div class="form-group">
                <label for="clientId">Client ID de Google:</label>
                <input type="text" id="clientId" placeholder="123456789-abcdefg.apps.googleusercontent.com">
            </div>
            
            <div class="form-group">
                <label for="spreadsheetId">ID de Google Sheet:</label>
                <input type="text" id="spreadsheetId" placeholder="1A2B3C4D5E6F7G8H9I0J1K2L3M4N5O6P7Q8R">
            </div>
            
            <button class="btn" onclick="runDiagnostics()" id="diagBtn">üîç Ejecutar Diagn√≥stico</button>
            <button class="btn" onclick="testBasicConnection()" id="basicBtn" disabled>üß™ Prueba B√°sica</button>
            <button class="btn" onclick="initializeAPI()" id="initBtn" disabled>üöÄ Inicializar API</button>
        </div>

        <div id="statusArea"></div>
        <div id="errorDetails"></div>

        <div class="log-area" id="logArea">
            <div>[SISTEMA] Diagn√≥stico inicializado - Execute diagn√≥stico para comenzar</div>
        </div>
    </div>

    <script>
        // Variables globales
        let diagnosticResults = {};
        
        // Informaci√≥n del entorno actual
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('currentDomain').textContent = window.location.hostname;
            document.getElementById('currentProtocol').textContent = window.location.protocol;
            document.getElementById('userAgent').textContent = navigator.userAgent.substring(0, 80) + '...';
            
            log('Sistema cargado - Informaci√≥n del entorno capturada', 'SUCCESS');
        });
        
        // Funci√≥n para mostrar status
        function showStatus(message, type) {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `<div class="status status-${type}">${message}</div>`;
        }
        
        // Funci√≥n para mostrar detalles de error
        function showErrorDetails(details) {
            const errorArea = document.getElementById('errorDetails');
            errorArea.innerHTML = `<div class="error-details"><strong>Detalles del Error:</strong><br>${details}</div>`;
        }
        
        // Funci√≥n para log
        function log(message, type = 'INFO') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'INFO': '#74b9ff',
                'SUCCESS': '#00b894',
                'ERROR': '#fd7979',
                'WARNING': '#fdcb6e',
                'DEBUG': '#a29bfe'
            };
            
            const entry = document.createElement('div');
            entry.style.color = colors[type] || '#ffffff';
            entry.innerHTML = `[${timestamp}] [${type}] ${message}`;
            
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        // Ejecutar diagn√≥sticos completos
        function runDiagnostics() {
            log('=== INICIANDO DIAGN√ìSTICOS COMPLETOS ===', 'INFO');
            
            const clientId = document.getElementById('clientId').value.trim();
            const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            
            // Test 1: Validar formato de credenciales
            log('Test 1: Validando formato de credenciales...', 'DEBUG');
            
            if (!clientId) {
                log('‚ùå Client ID vac√≠o', 'ERROR');
                showStatus('‚ùå Falta Client ID', 'error');
                return;
            }
            
            if (!clientId.includes('.apps.googleusercontent.com')) {
                log('‚ùå Client ID no tiene formato correcto', 'ERROR');
                showStatus('‚ùå Client ID debe terminar en .apps.googleusercontent.com', 'error');
                return;
            }
            
            if (!spreadsheetId) {
                log('‚ùå Spreadsheet ID vac√≠o', 'ERROR');
                showStatus('‚ùå Falta ID de Google Sheet', 'error');
                return;
            }
            
            if (spreadsheetId.length < 20) {
                log('‚ùå Spreadsheet ID muy corto (posible error)', 'WARNING');
                showStatus('‚ö†Ô∏è ID de Google Sheet parece muy corto', 'warning');
            }
            
            log('‚úÖ Formato de credenciales v√°lido', 'SUCCESS');
            
            // Test 2: Verificar entorno
            log('Test 2: Verificando entorno de ejecuci√≥n...', 'DEBUG');
            log(`Dominio: ${window.location.hostname}`, 'INFO');
            log(`Protocolo: ${window.location.protocol}`, 'INFO');
            log(`URL completa: ${window.location.href}`, 'INFO');
            
            if (window.location.protocol !== 'https:') {
                log('‚ùå No se est√° ejecutando en HTTPS', 'ERROR');
                showStatus('‚ùå Google OAuth requiere HTTPS', 'error');
                return;
            }
            
            log('‚úÖ Entorno HTTPS v√°lido', 'SUCCESS');
            
            // Test 3: Verificar disponibilidad de Google API
            log('Test 3: Verificando Google APIs...', 'DEBUG');
            
            if (typeof window.gapi === 'undefined') {
                log('‚ùå Google API no cargada', 'ERROR');
                showStatus('‚ùå Error cargando Google APIs', 'error');
                showErrorDetails('window.gapi is undefined - Verifique su conexi√≥n a internet');
                return;
            }
            
            log('‚úÖ Google API disponible', 'SUCCESS');
            
            // Test 4: Verificar configuraci√≥n de dominio
            log('Test 4: Informaci√≥n de configuraci√≥n requerida...', 'DEBUG');
            log(`DEBE agregar en Google Cloud Console:`, 'WARNING');
            log(`Origen autorizado: https://${window.location.hostname}`, 'WARNING');
            log(`Client ID proporcionado: ${clientId.substring(0, 20)}...`, 'INFO');
            
            // Habilitar siguiente paso
            document.getElementById('basicBtn').disabled = false;
            showStatus('‚úÖ Diagn√≥stico b√°sico completado - Proceda con prueba b√°sica', 'success');
            
            log('=== DIAGN√ìSTICO B√ÅSICO COMPLETADO ===', 'SUCCESS');
        }
        
        // Prueba b√°sica de conexi√≥n
        function testBasicConnection() {
            log('=== INICIANDO PRUEBA B√ÅSICA DE CONEXI√ìN ===', 'INFO');
            
            try {
                log('Verificando disponibilidad de gapi.load...', 'DEBUG');
                
                if (typeof window.gapi.load !== 'function') {
                    throw new Error('gapi.load no es una funci√≥n');
                }
                
                log('‚úÖ gapi.load disponible', 'SUCCESS');
                
                log('Intentando cargar client:auth2...', 'DEBUG');
                document.getElementById('basicBtn').disabled = true;
                document.getElementById('basicBtn').textContent = 'üîÑ Probando...';
                
                window.gapi.load('client:auth2', {
                    callback: function() {
                        log('‚úÖ client:auth2 cargado exitosamente', 'SUCCESS');
                        document.getElementById('basicBtn').textContent = '‚úÖ Conexi√≥n OK';
                        document.getElementById('initBtn').disabled = false;
                        showStatus('‚úÖ Conexi√≥n b√°sica exitosa - Puede inicializar', 'success');
                        log('=== PRUEBA B√ÅSICA COMPLETADA ===', 'SUCCESS');
                    },
                    onerror: function(error) {
                        log(`‚ùå Error cargando client:auth2: ${error}`, 'ERROR');
                        showStatus('‚ùå Error en conexi√≥n b√°sica', 'error');
                        showErrorDetails(`Error: ${JSON.stringify(error)}`);
                        document.getElementById('basicBtn').disabled = false;
                        document.getElementById('basicBtn').textContent = 'üß™ Prueba B√°sica';
                    },
                    timeout: 10000,
                    ontimeout: function() {
                        log('‚ùå Timeout cargando APIs (10 segundos)', 'ERROR');
                        showStatus('‚ùå Timeout - Verifique su conexi√≥n', 'error');
                        document.getElementById('basicBtn').disabled = false;
                        document.getElementById('basicBtn').textContent = 'üß™ Prueba B√°sica';
                    }
                });
                
            } catch (error) {
                log(`‚ùå Error en prueba b√°sica: ${error.message}`, 'ERROR');
                showStatus(`‚ùå Error: ${error.message}`, 'error');
                showErrorDetails(error.stack);
            }
        }
        
        // Inicializar API completa
        async function initializeAPI() {
            log('=== INICIANDO INICIALIZACI√ìN COMPLETA ===', 'INFO');
            
            const clientId = document.getElementById('clientId').value.trim();
            const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            
            try {
                document.getElementById('initBtn').disabled = true;
                document.getElementById('initBtn').textContent = 'üîÑ Inicializando...';
                
                log('Inicializando gapi.client...', 'DEBUG');
                
                await window.gapi.client.init({
                    clientId: clientId,
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                    scope: 'https://www.googleapis.com/auth/spreadsheets'
                });
                
                log('‚úÖ gapi.client inicializado', 'SUCCESS');
                
                // Obtener instancia de autenticaci√≥n
                const authInstance = window.gapi.auth2.getAuthInstance();
                log('‚úÖ Instancia de autenticaci√≥n obtenida', 'SUCCESS');
                
                // Verificar estado de autenticaci√≥n
                if (authInstance.isSignedIn.get()) {
                    log('‚úÖ Usuario ya autenticado', 'SUCCESS');
                    onAuthSuccess();
                } else {
                    log('Iniciando proceso de autenticaci√≥n...', 'INFO');
                    const user = await authInstance.signIn();
                    log('‚úÖ Autenticaci√≥n exitosa', 'SUCCESS');
                    onAuthSuccess();
                }
                
            } catch (error) {
                log(`‚ùå Error en inicializaci√≥n: ${error.message}`, 'ERROR');
                showStatus(`‚ùå Error: ${error.message}`, 'error');
                
                // Mostrar detalles espec√≠ficos del error
                let errorDetails = `Error: ${error.message}\n`;
                if (error.details) {
                    errorDetails += `Detalles: ${JSON.stringify(error.details, null, 2)}\n`;
                }
                if (error.result && error.result.error) {
                    errorDetails += `Error de API: ${JSON.stringify(error.result.error, null, 2)}`;
                }
                
                showErrorDetails(errorDetails);
                
                document.getElementById('initBtn').disabled = false;
                document.getElementById('initBtn').textContent = 'üöÄ Inicializar API';
            }
        }
        
        // Funci√≥n cuando la autenticaci√≥n es exitosa
        function onAuthSuccess() {
            log('=== AUTENTICACI√ìN COMPLETADA EXITOSAMENTE ===', 'SUCCESS');
            showStatus('üéâ ¬°Conexi√≥n exitosa! API lista para usar', 'success');
            
            document.getElementById('initBtn').textContent = 'üéâ ¬°CONECTADO!';
            
            log('Sistema listo para enviar datos a Google Sheets', 'SUCCESS');
            log(`Spreadsheet ID: ${document.getElementById('spreadsheetId').value}`, 'INFO');
        }
    </script>
</body>
</html>
